name: Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    name: Gemini Code Review
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.ts
            **/*.tsx
            **/*.js
            **/*.jsx

      - name: Generate diff
        id: diff
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git diff origin/${{ github.base_ref }}...HEAD > diff.txt
          else
            git diff HEAD~1 HEAD > diff.txt
          fi
          
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì €ì¥
          git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || git diff --name-only HEAD~1 HEAD > changed_files.txt || echo "No changes"
          
          # diff ë‚´ìš©ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì €ì¥ (ìµœëŒ€ ê¸¸ì´ ì œí•œ)
          DIFF_CONTENT=$(cat diff.txt | head -c 50000)
          echo "diff_content<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
          CHANGED_FILES=$(cat changed_files.txt 2>/dev/null | tr '\n' ',' || echo "None")
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run Gemini Code Review
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "âš ï¸ GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "GitHub ë¦¬í¬ì§€í† ë¦¬ Settings > Secrets and variables > Actionsì—ì„œ GEMINI_API_KEYë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”."
            exit 1
          fi

          # ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
          if [ ! -s diff.txt ] || [ "${{ steps.diff.outputs.changed_files }}" = "None" ]; then
            echo "ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          fi

          # PR ì •ë³´ ìˆ˜ì§‘ (ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬)
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE=$(echo "${{ github.event.pull_request.title }}" | sed 's/"/\\"/g' | sed "s/'/\\'/g")
          PR_BODY=$(echo "${{ github.event.pull_request.body }}" | sed 's/"/\\"/g' | sed "s/'/\\'/g" | head -500)
          
          # Diff ë‚´ìš© ì½ê¸° (í¬ê¸° ì œí•œ)
          DIFF_CONTENT=$(cat diff.txt | head -c 80000 | sed 's/"/\\"/g' | sed 's/$/\\n/' | tr -d '\n')
          
          # í”„ë¡¬í”„íŠ¸ ìƒì„±
          PROMPT="ë‹¹ì‹ ì€ ê²½í—˜ ë§ì€ ì½”ë“œ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤. ë‹¤ìŒ Pull Requestì— ëŒ€í•œ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.

PR ì œëª©: ${PR_TITLE}
PR ì„¤ëª…: ${PR_BODY}

ë³€ê²½ëœ íŒŒì¼:
\`\`\`diff
${DIFF_CONTENT}
\`\`\`

ë‹¤ìŒ í•­ëª©ì— ëŒ€í•´ ë¦¬ë·°í•´ì£¼ì„¸ìš”:
1. ì½”ë“œ í’ˆì§ˆ ë° ë²„ê·¸ ê°€ëŠ¥ì„±
2. ì„±ëŠ¥ ì´ìŠˆ
3. ë³´ì•ˆ ë¬¸ì œ
4. ì½”ë“œ ìŠ¤íƒ€ì¼ ë° ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤
5. í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
6. ë¬¸ì„œí™”

ë¦¬ë·° ê²°ê³¼ë¥¼ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. êµ¬ì¡°í™”ëœ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ì¤‘ìš”í•œ ì´ìŠˆëŠ” ğŸ”´, ê²½ê³ ëŠ” ğŸŸ¡, ì œì•ˆì‚¬í•­ì€ ğŸ’¡, ê¸ì •ì ì¸ ë¶€ë¶„ì€ âœ…ë¡œ í‘œì‹œí•´ì£¼ì„¸ìš”."

          # JSON í˜ì´ë¡œë“œ ìƒì„±
          JSON_PAYLOAD=$(jq -n \
            --arg prompt "$PROMPT" \
            '{
              contents: [{
                parts: [{
                  text: $prompt
                }]
              }]
            }')
          
          # Gemini APIë¥¼ ì‚¬ìš©í•œ ì½”ë“œ ë¦¬ë·° ìš”ì²­
          REVIEW_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")
          
          # HTTP ìƒíƒœ ì½”ë“œ ë¶„ë¦¬
          HTTP_CODE=$(echo "$REVIEW_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$REVIEW_RESPONSE" | sed '/HTTP_CODE:/d')
          
          # ì‘ë‹µ ê²€ì¦
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âš ï¸ Gemini API í˜¸ì¶œ ì‹¤íŒ¨ (HTTP $HTTP_CODE):"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            REVIEW_TEXT="## âš ï¸ ì½”ë“œ ë¦¬ë·° ìƒì„± ì‹¤íŒ¨\n\nGemini API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (HTTP $HTTP_CODE).\n\nAPI í‚¤ì™€ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
          else
            # ì‘ë‹µì—ì„œ ë¦¬ë·° ë‚´ìš© ì¶”ì¶œ
            REVIEW_TEXT=$(echo "$BODY" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null)
            
            if [ "$REVIEW_TEXT" = "null" ] || [ -z "$REVIEW_TEXT" ]; then
              echo "âš ï¸ Gemini API ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜:"
              echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
              REVIEW_TEXT="## âš ï¸ ì½”ë“œ ë¦¬ë·° ìƒì„± ì‹¤íŒ¨\n\nGemini API ì‘ë‹µì„ íŒŒì‹±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            fi
          fi
          
          # ë¦¬ë·° ë‚´ìš©ì„ íŒŒì¼ë¡œ ì €ì¥
          echo "$REVIEW_TEXT" > review.md
          
          # GitHub Actions ì¶œë ¥ì— ì €ì¥
          {
            echo "review<<EOF"
            echo "$REVIEW_TEXT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Post review comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('review.md', 'utf8');
            
            // ê¸°ì¡´ ë´‡ ë¦¬ë·° ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(
              comment => comment.user.type === 'Bot' && comment.body.includes('## ğŸ¤– Gemini Code Review')
            );
            
            const body = `## ğŸ¤– Gemini Code Review\n\n${reviewContent}\n\n---\n*ì´ ë¦¬ë·°ëŠ” Gemini AIë¥¼ ì‚¬ìš©í•˜ì—¬ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;
            
            if (botComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              // ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Review summary
        if: always()
        run: |
          if [ -f review.md ]; then
            echo "## ğŸ“‹ ë¦¬ë·° ìš”ì•½"
            echo ""
            cat review.md | head -20
          fi

